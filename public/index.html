<meta name="viewport" content="width=device-width, initial-scale=1" />

work in progress ...

<br/>
build_version: _GIT_COMMIT_ID_

<br/>
build_timestamp: _GIT_COMMIT_TIMESTAMP_

<br/>
Check back later.

<br/>
by Tancredi-Paul Grozav &lt;paul@grozav.info&gt;

<hr/>

<button onclick="export_file()">Export</button>
or Import: <input type="file" accept="application/json" onchange="import_file(event)"/>

<hr/>

<a href="#products">products:</a>
<p id="list_of_products">&nbsp;</p>

<a href="#items">items:</a>
<p id="list_of_items">&nbsp;</p>

<a href="#product_edit">edit product:</a>
<p>
  Code:
  <select id="code_product_edit" size="2" />
  <br/>
  Name:
  <input type="text" id="name_product_edit"/>
</p>

<a href="#camera">camera:</a>
<p id="camera">&nbsp;</p>

<a href="#log">log:</a>
<p id="log">&nbsp;</p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" integrity="sha512-bCsBoYoW6zE0aja5xcIyoCDPfT27+cGr7AOCqelttLVRGay6EKGQbR6wm6SUcUGOMGXJpj+jrIpMS6i80+kZPw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
  // alert(Quagga);
  function log(msg)
  {
    document.getElementById("log").innerHTML += "<br/>" + msg;
  };

  // Function to download data to a file
  function download(data, filename, type)
  {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob)
    {
      // IE10+
      window.navigator.msSaveOrOpenBlob(file, filename);
    }
    else
    {
      // Others
      var a = document.createElement("a");
      var url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function()
      {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
      }, 0); 
    }
  };

  var db = {
    "products": [
      {
        "code_value": "1234567890123",
        "code_format": "ean_13",
        "name": "Iaurt Danone delicios 175g",
        "items": [
          {
            "expiration_year": 2025,
            "expiration_month": 5,
            "expiration_day": 25
          },
          {
            "expiration_year": 2024,
            "expiration_month": 5,
            "expiration_day": 25
          }
        ]
      },
      {
        "code_value": "3577060130017",
        "code_format": "ean_13",
        "name": "Chio popcorn sare 75g",
        "items": [
          {
            "expiration_year": 2024,
            "expiration_month": 10,
            "expiration_day": null
          },
          {
            "expiration_year": 2025,
            "expiration_month": 2,
            "expiration_day": 11
          },
          {
            "expiration_year": 2025,
            "expiration_month": 2,
            "expiration_day": 11
          }
        ]
      }
    ]
  };

  function import_file(event)
  {
    var input = event.target;
    var reader = new FileReader();
    reader.onload = function()
    {
      var text = reader.result;
      // log(text);
      db = JSON.parse(text);
    };
    reader.readAsText(input.files[0]);
  };

  function export_file()
  {
    var data = JSON.stringify(db);
    // log(data);
    download(data, "products.json", "application/json");
  };

  log("Starting...");

  var quagga_config = {
    inputStream:
    {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#camera')
    },
    decoder:
    {
      readers: ["ean_reader", "ean_8_reader"]
    }
  };

  function quagga_detected_handler(data)
  {
    var code = data.codeResult.code;
    var format = data.codeResult.format;
    //var prod_name = db.codes[code];
    var id = code + " " + format;
    log(id);
    var select_cpe = document.getElementById("code_product_edit");
    var found = false;
    for(var i=0; i<select_cpe.children.length; i++)
    {
      var option_i = select_cpe.children[i];
      if(option_i.value == id)
      {
        found = true;
        break;
      }
    }
    if(!found)
    {
      select_cpe.innerHTML += "<option value=\"" + id + "\">" + id + "</option>";
      select_cpe.size = 4; //select_cpe.children.length;
      log(select_cpe.children.length + " items");
    }
    log("done");
  };

  function quagga_init_handler(err)
  {
    if (err)
    {
      log(err);
      return;
    }
    log("Initialization finished. Ready to start");
    Quagga.start();
    Quagga.onDetected(quagga_detected_handler);
  };
  Quagga.init(quagga_config, quagga_init_handler);

  function list_items(product_index)
  {
    var list_div = document.getElementById("list_of_items");
    var html = "<table border=\"1px\">";
    html += "<tr>";
    html += "<td>index</td>";
    html += "<td>expiration_year</td>";
    html += "<td>expiration_month</td>";
    html += "<td>expiration_day</td>";
    html += "</tr>";
    db.products[product_index].items.forEach(function callback(item, index)
    {
      html += "<tr>";
      html += "<td>" + index + "</td>";
      html += "<td>" + item.expiration_year + "</td>";
      html += "<td>" + item.expiration_month + "</td>";
      html += "<td>" + item.expiration_day + "</td>";
      html += "</tr>";
    });
    html += "</table>";
    list_div.innerHTML = html;
  };

  function list_products(highlited_index)
  {
    var list_div = document.getElementById("list_of_products");
    var html = "<table border=\"1px\">";
    html += "<tr>";
    html += "<td>index</td>";
    html += "<td>name</td>";
    html += "<td>code_value</td>";
    html += "<td>code_format</td>";
    //html += "<td>expiration_year</td>";
    //html += "<td>expiration_month</td>";
    //html += "<td>expiration_day</td>";
    html += "</tr>";
    db.products.forEach(function callback(p, index)
    {
      html += "<tr onclick=\"list_products(" + index + "); list_items(" + index + ");\"";
      if(highlited_index !== undefined &&
        index == highlited_index)
      {
        html += "style=\"background-color: yellow;\"";
      }
      html += ">";
      html += "<td>" + index + "</td>";
      html += "<td>" + p.name + "</td>";
      html += "<td>" + p.code_value + "</td>";
      html += "<td>" + p.code_format + "</td>";
      //html += "<td>" + p.expiration_year + "</td>";
      //html += "<td>" + p.expiration_month + "</td>";
      //html += "<td>" + p.expiration_day + "</td>";
      html += "</tr>";
    });
    html += "</table>";
    list_div.innerHTML = html;
  };
  list_products();
</script>
