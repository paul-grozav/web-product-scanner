<meta name="viewport" content="width=device-width, initial-scale=1" />

work in progress ...

<br/>
build_version: _GIT_COMMIT_ID_

<br/>
build_timestamp: _GIT_COMMIT_TIMESTAMP_

<br/>
Check back later.

<br/>
by Tancredi-Paul Grozav &lt;paul@grozav.info&gt;

<hr/>

<button onclick="export_file()">Export</button>
or Import: <input type="file" accept="application/json" onchange="import_file(event)"/>

<hr/>

<p id="camera"/>
<p id="list"/>
<p id="log"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" integrity="sha512-bCsBoYoW6zE0aja5xcIyoCDPfT27+cGr7AOCqelttLVRGay6EKGQbR6wm6SUcUGOMGXJpj+jrIpMS6i80+kZPw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
  // alert(Quagga);
  function log(msg)
  {
    document.getElementById("log").innerHTML += "<br/>" + msg;
  };

  // Function to download data to a file
  function download(data, filename, type)
  {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob)
    {
      // IE10+
      window.navigator.msSaveOrOpenBlob(file, filename);
    }
    else
    {
      // Others
      var a = document.createElement("a");
      var url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function()
      {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
      }, 0); 
    }
  };

  var db = {
    "products": [
      {
        "id": 1,
        "code_value": "1234567890123",
        "code_format": "ean_13",
        "name": "Iaurt Danone delicios 175g",
        "items": [
          {
            "id": null,
            "expiration_year": 2025,
            "expiration_month": 5,
            "expiration_day": 25
          },
          {
            "id": null,
            "expiration_year": 2024,
            "expiration_month": 5,
            "expiration_day": 25
          }
        ]
      },
      {
        "id": 2,
        "code_value": "3577060130017",
        "code_format": "ean_13",
        "name": "Chio popcorn sare 75g",
        "items": [
          {
            "id": null,
            "expiration_year": 2024,
            "expiration_month": 10,
            "expiration_day": null
          },
          {
            "id": null,
            "expiration_year": 2024,
            "expiration_month": 5,
            "expiration_day": 25
          }
        ]
      }
    ]
  };

  function import_file(event)
  {
    var input = event.target;
    var reader = new FileReader();
    reader.onload = function()
    {
      var text = reader.result;
      // log(text);
      db = JSON.parse(text);
    };
    reader.readAsText(input.files[0]);
  };

  function export_file()
  {
    var data = JSON.stringify(db);
    // log(data);
    download(data, "products.json", "application/json");
  };

  log("Starting...");

  var quagga_config = {
    inputStream:
    {
      name: "Live",
      type: "LiveStream",
      // Or '#yourElement' (optional)
      target: document.querySelector('#camera')
    },
    decoder:
    {
      readers: ["ean_reader", "ean_8_reader"]
    }
  };

  function quagga_detected_handler(data)
  {
    var code = data.codeResult.code;
    //var prod_name = db.codes[code];
    log("onDetected: " + code + " format: " + data.codeResult.format + " name: "/* + prod_name*/);
  };

  function quagga_init_handler(err)
  {
    if (err)
    {
      log(err);
      return;
    }
    log("Initialization finished. Ready to start");
    Quagga.start();
    Quagga.onDetected(quagga_detected_handler);
  };
  Quagga.init(quagga_config, quagga_init_handler);

  function list_products()
  {
    var list_div = document.getElementById("list");
    var html = "<table border=\"1px\">";
    html += "<tr>";
    html += "<td>ID</td>";
    html += "<td>Name</td>";
    html += "<td>code_format</td>";
    html += "<td>code_value</td>";
    //html += "<td>expiration_year</td>";
    //html += "<td>expiration_month</td>";
    //html += "<td>expiration_day</td>";
    html += "</tr>";
    db.products.forEach((p) =>
    {
      html += "<tr>";
      html += "<td>" + p.id + "</td>";
      html += "<td>" + p.name + "</td>";
      html += "<td>" + p.code_value + "</td>";
      html += "<td>" + p.code_format + "</td>";
      //html += "<td>" + p.expiration_year + "</td>";
      //html += "<td>" + p.expiration_month + "</td>";
      //html += "<td>" + p.expiration_day + "</td>";
      html += "</tr>";
    });
    html += "</table>";
    list_div.innerHTML = html;
  };
  list_products();
</script>
